name: Build Windows Installer

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: windows-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Display environment info
        run: |
          Write-Host "=== Build Environment ==="
          Write-Host "Node: $(node --version)"
          Write-Host "NPM: $(npm --version)"
          Write-Host "Platform: Windows"
          Write-Host "Workspace: ${{ github.workspace }}"
          Write-Host "========================"

      - name: Install dependencies
        run: npm install --prefer-offline --no-audit --no-fund
        timeout-minutes: 15

      - name: Build Windows installer
        run: npm run build-win -- --publish never
        timeout-minutes: 15
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          DEBUG: electron-builder

      - name: Verify build output
        shell: pwsh
        run: |
          Write-Host "=== Build Artifacts ==="
          
          if (Test-Path "dist") {
            $files = Get-ChildItem dist -Recurse
            $files | Format-Table Name, Length, LastWriteTime -AutoSize
            
            $installer = Get-ChildItem dist -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            
            if ($installer) {
              $sizeMB = [math]::Round($installer.Length / 1MB, 2)
              Write-Host ""
              Write-Host "SUCCESS: Installer found - $($installer.Name) ($sizeMB MB)"
              
              # Write to GitHub Step Summary
              "### Build Complete!" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "**File:** $($installer.Name)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "**Size:** $sizeMB MB" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              "**Path:** ``dist/``" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            } else {
              Write-Host "ERROR: No .exe installer found in dist folder!"
              exit 1
            }
          } else {
            Write-Host "ERROR: dist folder not found!"
            exit 1
          }

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: Silent-Print-Agent-Windows-v${{ github.run_number }}
          path: dist/*.exe
          if-no-files-found: error
          retention-days: 90

      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: |
            dist/*.yml
            dist/*.blockmap
          if-no-files-found: ignore
          retention-days: 30
