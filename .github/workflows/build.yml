name: Build Windows Installer

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: windows-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 40

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“Š Environment info
        run: |
          echo "=== Build Environment ==="
          echo "Node: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "Platform: Windows"
          echo "Workspace: ${{ github.workspace }}"
          echo "========================"

      - name: ğŸ“¦ Install dependencies
        run: npm install --prefer-offline --no-audit --no-fund
        timeout-minutes: 15

      - name: ğŸ”¨ Build Windows installer (no publish)
        run: npm run build-win -- --publish never
        timeout-minutes: 15
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          DEBUG: electron-builder

      - name: ğŸ“‚ Verify build output
        run: |
          echo "=== Build Artifacts ==="
          if (Test-Path "dist") {
            $files = Get-ChildItem dist -Recurse
            $files | Format-Table Name, Length, LastWriteTime -AutoSize
            
            $installer = Get-ChildItem dist -Filter *.exe | Select-Object -First 1
            if ($installer) {
              $sizeMB = [math]::Round($installer.Length / 1MB, 2)
              echo ""
              echo "âœ… Installer: $($installer.Name) (${sizeMB} MB)"
              
              echo "### âœ… Build Complete!" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "**File:** $($installer.Name)" >> $env:GITHUB_STEP_SUMMARY
              echo "**Size:** ${sizeMB} MB" >> $env:GITHUB_STEP_SUMMARY
              echo "**Path:** \`dist/\`" >> $env:GITHUB_STEP_SUMMARY
            } else {
              echo "âŒ No .exe installer found!"
              exit 1
            }
          } else {
            echo "âŒ dist folder not found!"
            exit 1
          }

      - name: ğŸ“¤ Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: Silent-Print-Agent-Windows-v${{ github.run_number }}
          path: dist/*.exe
          if-no-files-found: error
          retention-days: 90

      - name: ğŸ“¤ Upload build metadata (optional)
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: |
            dist/*.yml
            dist/*.blockmap
          if-no-files-found: ignore
          retention-days: 30
